# jsonConnect
Secure TCP protocol

##Features
 * Server/Client JSON Network Interface
 * Send and Answer commands

 

## Installation

```bash
$ npm install git https://npm:npmkdfu29ejij@tools.comvalue.com/bitbucket/scm/nod/jsonconnect.git
```

## General

Server and clients operate almost similar except the server accepts client connections and the client connects to a server.

One single connection is the connectionData object, which is given to all callbacks. There can all necessary information for one connection be stored.

## Server
### Class: JsonSocketServer in jsonSocketServer.js

Creates one connectionData object for each connection.

constructor(config, onUnknownCommandFunction)

#### createServer(listenIp, port)
Creates listen Server on ip and port.

#### config options:

key: path to private key file

cert: path to certification file

log: logInstance to use. If not provided uses logLevel instead.

if key and cert are both in config, server will use tls

onUnknownCommandFunction will be called like a registrated command if the command is unknown


## Clients
### Class: JsonSocketClient in jsonSocketClient.js

The JsonSocketClients objects handles multiple clients. To differentiate connection, the connectionData object is given in the connect callback.

constructor(config, onUnknownCommandFunction)


#### config options:
useTls: if true, client will use tls

onUnknownCommandFunction will be called like a registrated command if the command is unknown

#### connect(ip, port, connectCallback => (connected, connectionData))
Connects to the JsonSocketServer. Calls connectCallback after connection established.


## Server and clients commands

#### setOnDisconnect(disconnectCallback => (connectionData))
Called after an disconnect.

#### registrateCommand(command, commandCallback => (json, connectionData, next), ...)
CommandCallback is called if the requested command is incoming. Every request HAVE TO be answered with sendResponse.
You can give multipe commandCallback which are called serial on call of next() in callback.
Sent Binaries are appended in json.binaries array and in json.appendedBinaries is the count of binaries (only if binaries are sent, else both is undefined).

#### sendRequest(connectionData, command, params, callbackOnAnswer => (json, resultConnectionData), appendBinaries, , sendTimeout)
Send an request with command and params to the connectionData connection. An requestId is automatically appended. You can append one or more binaries with appendBinaries (single buffer oder Array of buffers).
On receiver call of sendResponse your callbackOnAnswer is called. Binary handling in the response is similar to registrateCommand.
SendTimeout will overwrite a general sendTimeout. If an timeout is set the connection will disconnect if no answer was received in the time.

#### sendResponse(connectionData, responseId, errorCode, params, appendBinary)
With this command you send an response to a request. ResponseId have to be json.requestId. You can append binaries like in sendRequest.

#### setDisconnectTimeout(milliseconds)
Disconnects the connection after milliseconds inactivity.

#### setSendTimeout(milliseconds)
Send a standard timeout for sendRequest.

#### setRemoveResponseFieldsNotInSchema(bool)
Set if in Responses additional Fields which are not defined in schema are removed.

#### setDisconnectOnSendTimeout(bool)
Set if a connection is closed on a send timeout. Default is true.